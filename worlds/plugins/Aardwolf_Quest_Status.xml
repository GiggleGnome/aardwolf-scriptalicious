<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, July 05, 2008, 4:46 PM -->
<!-- MuClient version 4.31 -->

<!-- Plugin "Aardwolf_Tick_Timer" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Aardwolf_Quest_Status"
   author="WinkleWinkle"
   id="e50b1d08a0cfc0ee9c442000"
   language="Lua"
   purpose="The current quest info is shown on the status bar."
   date_written="2011-05-05 16:46:02"
   requires="4.31"
   version="1.0"
   save_state="y"
   >

</plugin>

<aliases>

	<alias
	   script="SetShowStatus"
	   match="^showStatus (.*)?$"
	   enabled="y"
	   regexp="y"
	   sequence="100"
	   ignore_case="y"
	  >
	 </alias>

	<alias
	   script="SetShowInfo"
	   match="^showInfo (.*)?$"
	   enabled="y"
	   regexp="y"
	   sequence="100"
	   ignore_case="y"
	  >
	 </alias>

</aliases>

<triggers>		
	
	<trigger
		name="quest_trigger"
		enabled="y"
		match="^(?:.+ tells you \'Thank you\, brave .+\!\'|.+ tells you \'Aardwolf\'s most heinous criminal\, .+\,\'|.+ tells you \'has escaped from the dungeon\!\'|.+ tells you \'Since the escape\, .+ has murdered \'|.+ tells you \'.+ civilians\! The penalty for this crime is death\, and\'|.+ tells you \'you are to deliver the sentence\!\'|.+ tells you \'An enemy of mine\, .+\, is making vile\'|.+ tells you \'threats against .+\! This threat must be eliminated\!\'|.+ tells you \'Seek .+ out somewhere in the vicinity\'|.+ tells you \'of .+ which is in the general area\'|.+ tells you \'of .+\.\'|.+ tells you \'Good luck .+\. Return safely\!\')$"
		regexp="y"
		omit_from_output="y"
		omit_from_log="y"
		sequence="100">
	</trigger>

</triggers>

<script>
<![CDATA[

require "serialize"
require "movewindow"
require "commas"
require "gmcphelper"

-- pull in telnet option handling
dofile (GetPluginInfo (GetPluginID (), 20) .. "telnet_options.lua")

local lastQuest = ""
local showStatus = tonumber(GetVariable("ShowQuestInStatus")) or 1
local showInfo = tonumber(GetVariable("ShowQuestInInfo")) or 1
local refresh = false

function startQuest(mob, room, area, questText)

	local pattern = mob .. "|" .. room .. "|" .. area

	if (lastQuest == pattern) then
		-- duplicate request from multi-line regex match
		return
	end	
	lastQuest = pattern
	
	Note("Quest: Kill " .. questText)
end

function OnPluginBroadcast (msg, id, name, text)

   -- Look for GMCP handler.
   if (id == '3e7dedbe37e44942dd46d264') then

      if (text == "comm.quest") then
      	 
         res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","comm")
         luastmt = "gmcpdata = " .. gmcparg
         assert (loadstring (luastmt or "")) ()
         local action = gmcpval("quest.action")
         
         if (action == "status" and gmcpval("quest.wait") ~= "") then
			questText = "Waiting to quest" -- .. gmcpval("quest.wait") .. " minutes"
			WriteInfo(questText)
			WriteStatus(questText)			
			lastQuest = ""
			refresh = false
         elseif (action == "ready" or (action == "status" and gmcpval("quest.status") == "ready")) then
         	questText = "Ready to quest!"
			WriteInfo(questText)
			WriteStatus(questText)
			lastQuest = ""
			refresh = false
         elseif (action == "start" or (action == "status" and gmcpval("quest.timer") ~= "")) then
			-- on a quest!			
			questText = gmcpval("quest.targ") .. " in " .. gmcpval("quest.room") .. " at " .. gmcpval("quest.area") .. " in " .. gmcpval("quest.timer") .. " minutes"			
			WriteInfo(questText)
			WriteStatus(questText)			
			startQuest(gmcpval("quest.targ"), gmcpval("quest.room"), gmcpval("quest.area"), questText)			
			refresh = true
         elseif (action == "killed"  or (action == "status" and gmcpval("quest.target") == "killed")) then
			questText = "Your quest is almost complete! Return to a quest master!"
			WriteInfo(questText)
			WriteStatus(questText)
			refresh = false
         elseif (action == "comp" or action == "fail") then
			questText = ""
			WriteInfo("")
			WriteStatus(questText)
			lastQuest = ""
			refresh = false
		    Execute("sendgmcp request quest") 
         end
      end
   end
end

function SetShowStatus(name, line, wildcards)
  
  newval = tonumber(wildcards[1])
  if not newval or newval > 1 or newval < 0 then
    ColourNote("darkorange", "", "SetShowStatus valid values are: 0 - off, 1 - on")
    return
  end
  
  showStatus = newval
  local msg = "off"
  if showStatus == 1 then
    msg = "on"
    Execute("sendgmcp request quest") 
  else
    SetStatus("")
  end
  ColourNote ("darkorange", "", "SetShowStatus: " .. msg)
end

function SetShowInfo(name, line, wildcards)
  
  newval = tonumber(wildcards[1])
  if not newval or newval > 1 or newval < 0 then
    ColourNote("darkorange", "", "SetShowInfo valid values are: 0 - off, 1 - on")
    return
  end
  
  showInfo = newval
  local msg = "off"
  if showInfo == 1 then
    msg = "on"
    Execute("sendgmcp request quest")
  else
  	InfoClear()
  end
  ColourNote ("darkorange", "", "SetShowInfo: " .. msg)
end

function WriteStatus(text)
	if (showStatus == 1) then
		SetStatus(text)	
	end
end

function WriteInfo(text)
	if (showInfo == 1) then
		InfoClear()
		Info(text)	
	end
end

function OnPluginTelnetOption (option)
	if option == string.char (101,1) then
		if (refresh == true) then
			Execute("sendgmcp request quest")
		end			
	end
end -- function

function OnPluginSaveState()
    SetVariable("ShowQuestInStatus", showStatus)
    SetVariable("ShowQuestInInfo", showInfo)
end


]]>
</script>




</muclient>
